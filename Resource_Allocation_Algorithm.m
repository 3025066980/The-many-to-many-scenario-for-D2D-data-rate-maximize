clear all ;
tic
clc;
fid11               =      ['R_DUE','.txt'];
c1                  =      fopen(fid11,'w');
fid22               =      ['Rm1_DUE_ini','.txt'];
c2                  =      fopen(fid22,'w');
fid33               =      ['Rm1_DUE','.txt'];
c3                  =      fopen(fid33,'w');
for l = 1 : 1
%% 函数作用：实现用户的资源分配


%global  submodeltype;

global K I J Pmax Gain Gain1 Gain2 Gain3 Gain4 Rreqj gkj0 gkji gki0 gki_i

submodeltype    =       0;
K               =       10; %载波数
I               =       3; %D2D用户数
J               =       3; %CUE用户数

B               =       1.5*10^4;         %子载波的带宽为15kHz
N0              =       10^(-(174/10))*10^(-3)*B;%每个子载波的噪声功率 W   -174dBm/Hz
%% 初始迭代功率
pmki            =       (0.2/K)*ones(K,I); %DUE功率集合
pmkj            =       (0.2/K)*ones(K,J); %CUE功率集合
%% 最大功率限制
Pmaxi           =       0.2*ones(I,1);
Pmaxj           =       0.2*ones(J,1);
Pmax            =       [Pmaxi;Pmaxj];
%% 基本数据速率需求
Rreqj           =       5*ones(J,1);
%% CUE-BS信道增益
[Gain]          =       Gain_CUE(K,J);
%Gain = rand(J,K);
%数据1
%Gain          = [8.2347e-08,0.02773,2.0425e-06,6.7924e-09,0.001428,8.9697e-07,0.002267,2.7335e-05;9.5437e-08,1.4570e-07,8.9026e-12,6.9907e-11,2.9951e-12,4.2038e-09,4.0860e-14,1.8606e-10];
%数据2
%Gain          = [5.2780e-11,9.1223e-11,7.1035e-14,6.6208e-11,1.2819e-07,1.3041e-11,3.0789e-08,4.3266e-09;9.3463e-13,2.4305e-09,1.6368e-11,2.8203e-16,1.2489e-08,4.3149e-15,1.6902e-08,8.4993e-09];
%数据3
%Gain          = [2.5408e-10,1.8758e-07,2.4119e-09,1.4994e-14,8.6969e-08,2.5203e-10,9.7036e-06,1.9105e-07;3.2661e-05,0.0002297,1.1028e-05,2.4935e-07,1.6362e-09,6.6177e-06,5.4939e-07,3.9318e-10];
%数据4
%Gain          = [5.4301e-07,4.4815e-13,2.9256e-10,6.3506e-06,1.4526e-09,8.5277e-12,1.7858e-07,1.2465e-05;0.0169539,1.2415e-10,5.2726e-09,0.0040997,3.3326e-06,1.4848e-06,2.0588e-07,5.2833e-06];
%数据5
%Gain          = [6.3098e-15,3.4048e-09,1.5055e-12,3.6324e-07,6.8013e-10,3.2926e-12,5.1005e-10,1.7199e-11;6.0632e-06,3.4420e-14,2.0462e-13,2.0894e-10,1.9663e-11,7.5600e-08,1.5749e-12,5.8500e-11];

%Gain          = [3.0441e-05,1.0943e-07,9.7974e-06,3.7660e-04,3.7028e-08,7.3644e-06,4.9445e-05,2.0628e-06;6.1924e-07,5.1732e-04,6.7624e-08,5.5584e-05,3.9334e-07,5.2011e-06,1.6600e-06,4.9488e-05];

gkj0            =       Gain';
%% DUE i - DUE i信道增益
[Gain1]         =       Gain_DUE(K,I);%DUE对之间的信道增益
%Gain1 = rand(I,K);
%Gain1           =       [0.0094,0.2824,0.0070,0.0003,0.0052,0.0070,0.0052,0.0057;0.0009,0.0036,0.0097,0.0080,0.0016,0.0014,0.0391,0.0074];

%数据1
%Gain1         =   [0.0044,0.001568,0.00326,0.00314,0.0089,0.0025,0.00311,0.0041;0.00708,0.00144,0.0087,0.00083,0.0046,0.00030,0.0075,0.0070];
%数据2
%Gain1          =[0.002145,0.0068,0.00557,0.0085,0.0056,0.009,0.0042,0.0036;0.0049,0.0026,0.0093,0.0047,0.0025,0.004,0.007,0.004]
%数据3
%Gain1      = [0.0053,0.0071,0.0050,0.0049,0.005,0.0094,0.0039,0.00117;0.0024,0.0068,0.0084,0.0097,0.0022,0.0076,0.0058,0.004];
%数据4
%Gain1      =[0.0050,0.0031,0.0095,0.0098,0.0051,0.0099,0.0046,0.0043;0.0021,0.0019,0.0083,0.0073,0.0053,0.0083,0.005,0.0055];
%数5
%Gain1    =  [0.0067,0.00018,0.0012,0.0095,0.0098,0.00031,0.0049,0.0086;0.0024,0.0083,0.0081,0.0063,2.2382e-05,0.0038,0.0090,0.0068];

%% CUE-DUE 信道增益
[Gain2]          =       Gain_CUE_DUE(K,I,J);
%Gain2 = rand(J,K,I);
%   Gain2(:,:,1)    =       [6.5474e-10, 4.5e-7, 1.108e-5, 1.3103e-10, 3.5999e-13, 1e-8 3.0999e-10 5e-6;3.2891e-14, 2.6695e-12, 1.6784e-13, 1.5161e-14, 3.5123e-12, 1.308e-7, 1.4006e-11, 3.2784e-8];
%   Gain2(:,:,2)    =       [4.2352e-8, 2.9338e-5, 7.1650e-4, 8.4760e-9, 2.3286e-11, 3.8705e-7, 2.0052e-8, 2.9788e-6;4.2111e-14, 3.4177e-12, 2.1489e-13, 1.9411e-14, 4.4968e-12, 1.6747e-7, 1.7932e-11, 4.1973e-8];
%
%数据1
%Gain2(:,:,3)   =  [5.6361e-12,1.5985e-11,9.5277e-09,8.8786e-09,6.9156e-08,2.6375e-10,7.8223e-10,6.3842e-11;3.8182e-10,1.3555e-08, 1.5221e-13,1.5702e-07,3.8155e-08, 1.0124e-12,2.3505e-11,8.1722e-08];
%Gain2(:,:,4)    = [1.1676e-11,3.3117e-11, 1.9739e-08,1.8394e-08,1.4327e-07,5.4642e-10, 1.6206e-09, 1.3226e-10; 4.7262e-10,1.6778e-08,1.8840e-13,1.9436e-07,4.7228e-08, 1.2531e-12,2.9095e-11,1.0116e-07];
%数据2
%Gain2(:,:,1)  =[4.1206e-13,1.7316e-10,9.0377e-09,0.0100,1.4802e-10,1.5404e-15,1.7475e-10,2.5100e-11;1.1510e-07,2.9440e-11,0.0051, 2.5569e-13,7.0134e-08,2.1835e-06, 1.6382e-06,1.2171e-12];
%Gain2(:,:,2)  = [1.2784e-13,5.3723e-11, 2.8040e-09,0.0031,4.5925e-11,4.7790e-16,5.4216e-11,7.7873e-12;1.3350e-07,3.4147e-11, 0.0059,2.9657e-13,8.1347e-08,2.5326e-06, 1.9002e-06,1.4117e-12];
%数据3
%Gain2  (:,:,1)= [1.3770e-12,1.4192e-10,3.4416e-12,9.6015e-09,6.7466e-13,3.0484e-15,2.1234e-10,1.9204e-11;2.9666e-10, 1.5159e-11,8.3022e-05, 9.0122e-12,4.8006e-12, 1.1203e-05, 3.3594e-13,2.6491e-14,];
%Gain2(:,:,2) = [ 1.2619e-11,1.3006e-09,3.1539e-11,8.7989e-08,6.1826e-12,2.7936e-14,1.9459e-09,1.7598e-10;1.8337e-08,9.3698e-10,0.0051,5.5706e-10,2.9673e-10,6.9247e-04,2.0765e-11,1.6375e-12];
%数据4
%Gain2 (:,:,1) =[6.0727e-05,2.6189e-11,5.1376e-10,9.7609e-08,1.8099e-13,1.7808e-08,8.1093e-11, 8.7558e-14;1.8745e-13,5.0840e-07, 2.3445e-13,4.5716e-10, 2.9422e-08,0.0014,5.1073e-10,2.2170e-14];
%Gain2  (:,:,2) =[4.9157e-05,2.1199e-11,4.1587e-10,7.9012e-08,1.4650e-13,1.4415e-08,6.5642e-11,7.0876e-14;1.2687e-13,3.4409e-07,1.5868e-13,3.0941e-10,1.9913e-08,9.3322e-04, 3.4567e-10,1.5005e-14];
%数据5
%Gain2(:,:,1)  =  [ 2.4811e-07,3.8781e-08,2.6182e-11,4.2203e-09,8.3849e-07,5.9257e-08,1.6858e-09,1.4377e-07;2.5815e-04,2.4915e-06,1.0437e-10,1.9958e-11,1.2525e-06, 1.8517e-05, 3.4657e-11,3.3825e-06];
%Gain2(:,:,2)  = [1.2918e-08,2.0192e-09,1.3632e-12,2.1974e-10,4.3657e-08,3.0853e-09,8.7771e-11,7.4857e-09;6.2592e-05, 6.0409e-07,2.5305e-11,4.8389e-12,3.0368e-07,4.4895e-06, 8.4029e-12,8.2011e-07];

gkji            =       zeros(K,J,I);
for i           =       1:I
    gkji(:,:,i) =       Gain2(:,:,i)';
end
%% DUE-CUE 信道增益
[Gain3]         =       Gain_DUE_CUE(K,I);
%Gain3 = rand(I,K);
%Gain3           =      [2.2629e-09,3.8472e-09,5.8309e-09,2.5191e-09,2.9054e-09,6.1719e-09,2.6538e-09,8.2448e-09;9.8276e-09,7.3035e-09,3.4398e-09,5.8417e-09,1.0787e-09,9.0641e-09,8.7975e-09,8.1786e-09];

%数据1
%Gain3  =[2.5887e-10,5.7072e-08,5.0940e-11,1.1318e-12,3.7936e-13,8.2940e-08,6.2149e-08,5.6140e-08;7.1880e-07,9.8660e-11,2.6634e-05,6.8497e-08,9.7868e-13,2.5431e-09,5.9362e-13,8.1559e-11];
%数据2
%Gain3 =[2.3702e-12,1.1435e-10,0.0046,1.2276e-13,1.8141e-10,3.1946e-10,2.2559e-13,7.7872e-14;6.3633e-11,2.0664e-10,7.9381e-14,2.9702e-12,4.7523e-13,5.8760e-09,9.9851e-12,2.3271e-10];
%数据3
%Gain3=[1.8040e-10,7.6160e-12,6.7457e-13,4.8046e-11,8.2504e-06,8.5355e-13,3.6060e-12,2.4299e-07;6.7072e-06,1.2392e-10,1.1631e-12,1.3181e-08,3.0213e-08,4.5055e-11,8.8583e-12,8.8730e-09];
%数据4
%Gain3=[5.8404e-10,2.6327e-10,2.3563e-14,3.3640e-12,4.7921e-16,7.3560e-07,1.5033e-16,4.4913e-12;3.3975e-13,3.6317e-09,1.4044e-10,1.4820e-08,3.5208e-16,1.9216e-11,1.9224e-15,2.3882e-09];
%数据5
%Gain3 = [1.9454e-11,1.9718e-09,3.3373e-16,2.6269e-09,1.7100e-10,2.8841e-06,9.9622e-10,1.5921e-12;6.7603e-09,1.9059e-12,1.7570e-09,1.8727e-12,7.0773e-12,6.0006e-11,4.2115e-13,8.8186e-15];

gki0            =       Gain3';
%% DUE i-DUE i' 信道增益
[Gain4]         =       Gain_DUE_DUE(I,K);
%Gain4 = rand(I,K,I);
% Gain4(:,:,1)    =       [0 0 0 0 0 0 0 0;1.8303e-7    3.8609e-10    1.9762e-8    9.4544e-11   9.9398e-10    7.2583e-6    3.8180e-6    2.1458e-5];
% Gain4(:,:,2)    =       [5.0932e-7    6.0203e-8    1.6572e-11    8.2858e-13    0.0013    1.4001e-7    1.3692e-8    1.1768e-8; 0 0 0 0 0 0 0 0];

%数据1
%Gain4(:,:,1)    = [0 0 0 0 0 0 0 0;4.2526e-09 8.0864e-12 2.4922e-12 1.7946e-09 9.8829e-12 7.2021e-09 7.5027e-14  7.1301e-10];
%Gain4(:,:,2)    = [1.1682e-06 5.8544e-09 4.6965e-14 1.6841e-11 1.6620e-08 3.9311e-07 1.4185e-09 3.0697e-07;0 0 0 0 0 0 0 0 ];
%数据2
%Gain4(:,:,1)    =[0 0 0 0 0 0 0 0;9.5736e-10  9.5866e-05 2.9869e-05 4.3496e-06 0.0011 2.0503e-04 0.0022 5.2969e-05];
%Gain4(:,:,2)    =[2.4186e-11 1.0555e-06 4.6186e-06 3.3155e-09  3.7168e-10 5.4703e-12 1.0592e-06 1.1483e-08;0 0 0 0 0 0 0 0];
%数据3
%Gain4(:,:,1)    =[0 0 0 0 0 0 0 0;1.3720e-06 8.3693e-08 1.4994e-05 1.5191e-04 7.2407e-09 1.3177e-04 1.0927e-12 3.7634e-04];
%Gain4(:,:,2)    =[5.0177e-09 1.8101e-10 1.1970e-10 2.5417e-07 4.0662e-09 8.8247e-08 2.0120e-15 3.3530e-05; 0 0 0 0 0 0 0 0];

%数据4
%Gain4(:,:,1)    =[0 0 0 0 0 0 0 0;1.7365e-08 2.9968e-09 7.7764e-14 7.2781e-15 4.3095e-11 1.0577e-14 2.4012e-10 1.9833e-10];
%Gain4(:,:,2)    =[2.1498e-10 2.6518e-10 1.2021e-15 1.1482e-11 4.4910e-08 5.4020e-09 2.0177e-07 3.0478e-10;0 0 0 0 0 0 0 0];

%数据5
%Gain4(:,:,1)    =[0 0 0 0 0 0 0 0; 3.0209e-07 5.9470e-08 1.0662e-11 3.1275e-12  2.4350e-06 1.4500e-09 7.3921e-08 6.0195e-06];
%Gain4(:,:,2)    =[2.4218e-10 5.0724e-09 1.2046e-06 2.9546e-10 3.5575e-13 7.0317e-10 4.0201e-07 1.3116e-08;0 0 0 0 0 0 0 0];


gki_i           =       zeros(K,I,I);
for i=1:I
    gki_i(:,:,i)=Gain4(:,:,i)';
    gki_i(:,i,i)=Gain1(i,:);
end

%%
%[Phom1ki,Phom1kj,R_DUE] =   Subcarrier_Allocation_Algorithm5(pmki,pmkj)
[Phom1ki,Phom1kj,R_DUE] = Subcarrier_Allocation_Algorithm(pmki,pmkj);
fprintf(c1,'%1.16f\n',R_DUE);
Phomki                  =   Phom1ki;
Phomkj                  =   Phom1kj;
Rm_DUE                  =   R_DUE;
p0ki                    =  Phomki.*pmki;
p0kj                    =  Phomkj.*pmkj;
%[pm1ki,pm1kj,Rm1_DUE]=SQP_Power_Allocation_Algorithm(Phomki,Phomkj,pmki,pmkj);
[pm1ki,pm1kj,Rm1_DUE,Rm1_DUE_ini]   =   cvx_Power_Allocation_Algorithm(Phomki, Phomkj,p0ki,p0kj);
fprintf(c2,'%1.16f\n',Rm1_DUE_ini);
Rm1_DUE  =  Rm1_DUE  +357.0823
fprintf(c3,'%1.16f\n',Rm1_DUE);
pi_val                  =   pm1ki;
pj_val                  =   pm1kj;

end 
power_control_time=toc